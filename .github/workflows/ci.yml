name: Build Typst Projects

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest
          
      - name: Install fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-liberation fonts-jetbrains-mono fonts-noto
          
      - name: Find Typst projects with main.typst
        id: find_projects
        run: |
          echo "TYPST_DIRS=$(find . -name "main.typst" -o -name "main.typ" | xargs dirname | tr '\n' ' ')" >> $GITHUB_ENV
          mkdir -p build
      
      - name: Build PDFs from Typst projects
        run: |
          for dir in $TYPST_DIRS; do
            if [ -f "$dir/main.typst" ]; then
              main_file="$dir/main.typst"
            else
              main_file="$dir/main.typ"
            fi
            
            # Get relative path from repository root
            rel_dir="${dir#./}"
            
            echo "Building $main_file to build/$rel_dir/main.pdf"
            mkdir -p "build/$rel_dir"
            
            # Try to compile, continue if there's an error
            typst compile "$main_file" "build/$rel_dir/main.pdf" || echo "Failed to build $main_file, continuing..."
          done
      
      - name: Generate README with links
        run: |
          echo "# Typst Project PDFs" > build/README.md
          echo "" >> build/README.md
          echo "This branch contains automatically built PDFs from Typst source files." >> build/README.md
          echo "" >> build/README.md
          echo "## Available PDFs" >> build/README.md
          echo "" >> build/README.md
          
          find build -name "*.pdf" | sort | while read pdf; do
            relative_path="${pdf#build/}"
            echo "- [$relative_path]($relative_path)" >> build/README.md
          done
          
          # Add timestamp to show when the build was last run
          echo "" >> build/README.md
          echo "Last built: $(date)" >> build/README.md
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          branch: gh-pages
          clean: true
          commit-message: "Deploy Typst PDFs to GitHub Pages [skip ci]"
